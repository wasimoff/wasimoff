# wasimoff Broker

This is the central Broker component of Wasimoff. It is written in Go and provides the necessary WebSocket and HTTP sockets for Providers and Clients. In the simplest case, you can just run with the defaults locally, which will start the HTTP server on port `:4080`. During development, you can use [mitranim/gow](https://github.com/mitranim/gow) to watch for changes and automatically restart the server.

```
go run ./
```

Essential routes are all printed to the console on startup. Generally, all WebSocket and RPC interfaces use paths under `/api/...`:

* `/api/provider/ws`: WebSocket for connecting resource Providers, e.g. browsers and Deno runtimes
* `/api/client/ws`: WebSocket for Clients, that need to submit tasks asynchronously
* `/api/client/wasimoff.v1.Tasks/`: autogenerated ConnectRPC routes from Protobuf definitions; can be used with `curl` or [`connect-go`](https://github.com/connectrpc/connect-go) et al.
* `/api/storage/upload`: endpoint to POST WebAssembly executables and rootfs ZIP files for use in tasks; returns a stable sha256 reference that can be used as a filename

*Hint: If you want to implement your own clients to interact with the Broker, use `go get wasi.team/client` and check the documentation in the `../client/` directory.*


### Configuration

Configuration is done through environment variables but you can also write a `config.env` file (or just `.env`), which is loaded upon startup. You can get up-to-date help on the available environment keys using `go run ./ --help` or peeking inside the `config/configuration.go` file; the struct is not very complicated. An incomplete excerpt of the most important options:

| env | description | default |
| --- | ----------- | ------- |
| `WASIMOFF_HTTP_LISTEN`          | Listening address for HTTP server | `localhost:4080` |
| `WASIMOFF_HTTP_{CERT,KEY}`      | Certificate and key to enable TLS on the HTTP server | (empty = no TLS) |
| `WASIMOFF_ALLOWED_ORIGINS`      | List of allowed Origins for WebSocket connections | |
| `WASIMOFF_STATIC_FILES`         | Serve static files on `/` from here (e.g. the frontend) | `../webprovider/dist/` |
| `WASIMOFF_FILESTORAGE`          | Path to storage for uploaded files | `:memory:` (kept in RAM only) |
| `WASIMOFF_METRICS`              | Enable Prometheus exporter on `/metrics` | `false` |
| `WASIMOFF_DEBUG`                | Enable profiling handlers on `/debug/pprof` | `false` |


### Build Version

When you build the binary with `go build`, it will embed version information inside the binary, which is displayed upon launch:

```
$ go build
$ ./broker
                  _            __  __
  __ __ ____ _ __(_)_ __  ___ / _|/ _|
  \ V  V / _` (_-< | '  \/ _ \  _|  _|
   \_/\_/\__,_/__/_|_|_|_\___/_| |_|

   wasi.team/broker (f90a8a1-dirty) go1.24.0

2025/06/16 14:47:36 &config.Configuration{ ... }
```



#### Trivia: TLS Certificate for WebTransport

In a previous version, the Broker used WebTransport (bidirectional streams on HTTP/3 / QUIC) for Provider connections.
A WebTransport server **must** be TLS-secured, therefore a certificate-key-pair was **required**. You could either generate one externally or let the broker generate an emphemeral keypair on launch. This is possible because WebTransport connections in the browser [can use the certificate hash](https://developer.mozilla.org/en-US/docs/Web/API/WebTransport/WebTransport#browser_compatibility) to check certificate validity instead of needing to trust the PKI chain. However, this feature is not supported in Safari yet and Firefox can also check the browser's certificate trust store, so you could add your own development CA.

In general the entire API support was very heterogeneous among different engines for a long time and in pursuit of simplification the networking was completely rebuilt with Protobuf messages on well-supported WebSocket interfaces.
